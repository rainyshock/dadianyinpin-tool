<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>一键打点听力工具</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
      padding: 0 10px 80px; /* 给底部悬浮按钮留空间 */
      background: #f7f7f7;
    }
    button {
      font-size: 1rem;
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover { background-color: #45a049; }
    ul { list-style: none; padding: 0; }
    li { margin: 8px 0; cursor: pointer; color: #007BFF; }
    li:hover { text-decoration: underline; }
    input[type=number], input[type=file], input[type=text] {
      padding: 5px;
      margin: 5px;
      font-size: 1rem;
    }
    #offsetInput { width: 80px; }
    .mark-note { width: 60%; padding: 3px; font-size: 0.9rem; }
    .delete-btn { font-size: 0.8rem; padding: 2px 6px; margin-left: 5px; }

    /* 底部悬浮操作栏 */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 10px;
      background: white;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
    }
    .bottom-bar button {
      flex: 1;
      margin: 0 5px;
    }
    .mark-btn-big {
      background: #ff9800;
      font-size: 1.3rem;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h2>🎧 一键打点听力工具</h2>

  <!-- 文件选择 -->
  <input type="file" id="fileInput" accept=".mp3,audio/*"><br><br>
  <audio id="audioPlayer" controls style="width: 100%;"></audio><br>

  <!-- 偏移设置 -->
  <label>偏移秒数: <input type="number" id="offsetInput" value="3" min="0" max="5" step="0.1"></label><br>

  <!-- 导入导出 -->
  <button id="exportButton">💾 导出打点</button>
  <input type="file" id="importInput" accept="application/json" style="display:none">
  <button id="importButton">📂 导入打点</button>

  <h3>标记点：</h3>
  <ul id="marksList"></ul>

  <!-- 底部悬浮操作栏 -->
  <div class="bottom-bar">
    <button id="rewindButton">⏪ -5s</button>
    <button id="markButton" class="mark-btn-big">🔖 打点</button>
    <button id="forwardButton">⏩ +5s</button>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const audioPlayer = document.getElementById('audioPlayer');
    const markButton = document.getElementById('markButton');
    const offsetInput = document.getElementById('offsetInput');
    const marksList = document.getElementById('marksList');
    const rewindButton = document.getElementById('rewindButton');
    const forwardButton = document.getElementById('forwardButton');
    const exportButton = document.getElementById('exportButton');
    const importButton = document.getElementById('importButton');
    const importInput = document.getElementById('importInput');
    const STEP = 5;

    let marks = [];
    let audioFileName = 'audio';

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      audioFileName = file.name.replace(/\.[^/.]+$/, "");
      const url = URL.createObjectURL(file);
      audioPlayer.src = url;
      audioPlayer.load();
      marks = [];
      marksList.innerHTML = '';
    });

    function addMark() {
      if (!audioPlayer.src) return;
      const offset = parseFloat(offsetInput.value) || 0;
      const time = Math.max(0, audioPlayer.currentTime - offset);
      marks.push({time, note: ''});
      renderMarks();
    }
    markButton.addEventListener('click', addMark);

    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key === ' ') { e.preventDefault(); audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause(); }
      if (e.key === 'Alt') addMark();
      if (e.key === 'ArrowLeft') audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - STEP);
      if (e.key === 'ArrowRight') audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + STEP);
    });

    rewindButton.addEventListener('click', () => audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - STEP));
    forwardButton.addEventListener('click', () => audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + STEP));

    exportButton.addEventListener('click', () => {
      const dataStr = JSON.stringify(marks, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = audioFileName + '_打点.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    importButton.addEventListener('click', () => importInput.click());
    importInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if(Array.isArray(data)) marks = data; else marks = [];
          renderMarks();
        } catch { alert('文件格式错误'); }
      };
      reader.readAsText(file);
    });

    function renderMarks() {
      marksList.innerHTML = '';
      marks.forEach((m, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          标记 ${i+1} - ${formatTime(m.time)}
          <input type="text" class="mark-note" placeholder="记录你的疑问" value="${m.note || ''}">
          <button class="delete-btn">❌</button>
        `;
        li.querySelector('.mark-note').addEventListener('input', e => m.note = e.target.value);
        li.querySelector('.delete-btn').addEventListener('click', () => { marks.splice(i, 1); renderMarks(); });
        li.addEventListener('click', e => {
          if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
            audioPlayer.currentTime = m.time;
            audioPlayer.play();
          }
        });
        marksList.appendChild(li);
      });
    }

    function formatTime(s) {
      const min = Math.floor(s / 60), sec = Math.floor(s % 60);
      return `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }
  </script>
</body>
</html>
