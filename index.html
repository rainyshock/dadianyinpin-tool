<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸€é”®æ‰“ç‚¹å¬åŠ›å·¥å…·</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      text-align: center;
      padding: 0 10px;
    }
    button {
      font-size: 1.1rem;
      padding: 8px 16px;
      margin: 5px;
      border-radius: 8px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover { background-color: #45a049; }
    ul { list-style: none; padding: 0; }
    li { margin: 5px 0; cursor: pointer; color: #007BFF; }
    li:hover { text-decoration: underline; }
    input[type=number], input[type=file], input[type=text] {
      padding: 5px;
      margin: 5px;
      font-size: 1rem;
    }
    #offsetInput { width: 80px; }
    .mark-note { width: 60%; padding: 3px; font-size: 0.9rem; }
    .delete-btn { font-size: 0.8rem; padding: 2px 6px; margin-left:5px; }
  </style>
</head>
<body>
  <h2>ğŸ§ ä¸€é”®æ‰“ç‚¹å¬åŠ›å·¥å…·</h2>

  <!-- æ–‡ä»¶é€‰æ‹© -->
  <input type="file" id="fileInput" accept="audio/*"><br><br>
  <audio id="audioPlayer" controls style="width: 100%;"></audio><br>

  <!-- æ‰“ç‚¹å’Œåç§» -->
  <button id="markButton">ğŸ”– æ‰“ç‚¹ (Option)</button>
  <label>åç§»ç§’æ•°: <input type="number" id="offsetInput" value="3" min="0" max="5" step="0.1"></label><br>

  <!-- å¿«è¿›/å›æ”¾ -->
  <button id="rewindButton">âª å›æ”¾ 5 ç§’</button>
  <button id="forwardButton">â© å¿«è¿› 5 ç§’</button><br>

  <!-- å¯¼å…¥å¯¼å‡º -->
  <button id="exportButton">ğŸ’¾ å¯¼å‡ºæ‰“ç‚¹</button>
  <input type="file" id="importInput" accept="application/json" style="display:none">
  <button id="importButton">ğŸ“‚ å¯¼å…¥æ‰“ç‚¹</button>

  <h3>æ ‡è®°ç‚¹ï¼š</h3>
  <ul id="marksList"></ul>

  <script>
    const fileInput = document.getElementById('fileInput');
    const audioPlayer = document.getElementById('audioPlayer');
    const markButton = document.getElementById('markButton');
    const offsetInput = document.getElementById('offsetInput');
    const marksList = document.getElementById('marksList');
    const rewindButton = document.getElementById('rewindButton');
    const forwardButton = document.getElementById('forwardButton');
    const exportButton = document.getElementById('exportButton');
    const importButton = document.getElementById('importButton');
    const importInput = document.getElementById('importInput');
    const STEP = 5;

    let marks = [];
    let audioFileName = 'audio';

    // é€‰æ‹©éŸ³é¢‘
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      audioFileName = file.name.replace(/\.[^/.]+$/, "");
      const url = URL.createObjectURL(file);
      audioPlayer.src = url;
      audioPlayer.load();
      marks = [];
      marksList.innerHTML = '';
    });

    // æ·»åŠ æ‰“ç‚¹
    function addMark() {
      if (!audioPlayer.src) return;
      const offset = parseFloat(offsetInput.value) || 0;
      const time = Math.max(0, audioPlayer.currentTime - offset);
      marks.push({time, note: ''});
      renderMarks();
    }
    markButton.addEventListener('click', addMark);

    // å¿«æ·é”®ç›‘å¬
    document.addEventListener('keydown', e => {
      if (e.key === ' ') { e.preventDefault(); audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause(); }
      if (e.key === 'Alt') addMark();
      if (e.key === 'ArrowLeft') audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - STEP);
      if (e.key === 'ArrowRight') audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + STEP);
    });

    // å¿«è¿›/å›æ”¾
    rewindButton.addEventListener('click', () => { audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - STEP); });
    forwardButton.addEventListener('click', () => { audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + STEP); });

    // å¯¼å‡ºæ‰“ç‚¹
    exportButton.addEventListener('click', () => {
      const dataStr = JSON.stringify(marks, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = audioFileName + '_æ‰“ç‚¹.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // å¯¼å…¥æ‰“ç‚¹
    importButton.addEventListener('click', () => importInput.click());
    importInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if(Array.isArray(data)) marks = data; else marks = [];
          renderMarks();
        } catch {
          alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
        }
      };
      reader.readAsText(file);
    });

    // æ¸²æŸ“æ ‡è®°åˆ—è¡¨
    function renderMarks() {
      marksList.innerHTML = '';
      marks.forEach((m, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          æ ‡è®° ${i+1} - ${formatTime(m.time)}
          <input type="text" class="mark-note" placeholder="è®°å½•ä½ çš„ç–‘é—®" value="${m.note || ''}">
          <button class="delete-btn">åˆ é™¤</button>
        `;
        const noteInput = li.querySelector('.mark-note');
        noteInput.addEventListener('input', e => { m.note = e.target.value; });
        li.querySelector('.delete-btn').addEventListener('click', () => { marks.splice(i,1); renderMarks(); });
        li.addEventListener('click', e => {
          if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
            audioPlayer.currentTime = m.time; audioPlayer.play();
          }
        });
        marksList.appendChild(li);
      });
    }

    function formatTime(s) {
      const min = Math.floor(s/60), sec = Math.floor(s%60);
      return `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }
  </script>
</body>
</html>
