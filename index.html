<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>打点音频工具</title>
  <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
    #waveform { width: 95%; margin-top: 10px; }
    #controls { display: flex; justify-content: center; align-items: center; gap: 8px; margin: 8px 0; flex-wrap: wrap; }
    button { padding: 8px 14px; border-radius: 12px; border: none; background: #007AFF; color: white; font-size: 16px; }
    #floatingAdd {
      position: fixed; bottom: 90px; right: 20px;
      background: #FF3B30; color: white; border-radius: 50%;
      width: 56px; height: 56px; font-size: 24px;
      display: flex; justify-content: center; align-items: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    #markers { width: 95%; margin-top: 10px; }
    .marker { display: flex; align-items: flex-start; gap: 6px; margin-bottom: 6px; }
    .marker input[type="text"] {
      flex: 1;
      min-height: 28px;
      padding: 4px 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      resize: none;
      overflow: hidden;
    }
    .delete-btn {
      background: #FF3B30;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <h2>打点音频工具</h2>
  <input type="file" id="audioFile" accept="audio/*,video/mp4"><br>
  <div id="waveform"></div>

  <div id="controls">
    <button id="playPause">▶️ 播放</button>
    <label>偏移秒数: <input type="number" id="offset" step="0.1" value="0" style="width:60px;"></label>
    <button id="export">📤 导出</button>
    <input type="file" id="importFile" accept=".json" style="display:none;">
    <button id="importBtn">📥 导入</button>
  </div>

  <button id="floatingAdd">➕</button>

  <div id="markers"></div>

  <script>
    let wavesurfer, markers = [];

    function autoResizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + 'px';
    }

    function renderMarkers() {
      const container = document.getElementById('markers');
      container.innerHTML = '';
      markers.forEach((m, index) => {
        const div = document.createElement('div');
        div.className = 'marker';
        div.innerHTML = `
          <button onclick="wavesurfer.seekTo(${m.time / wavesurfer.getDuration()})">${m.time.toFixed(2)}s</button>
          <input type="text" value="${m.text}" oninput="markers[${index}].text=this.value; autoResizeTextarea(this);" />
          <button class="delete-btn" onclick="deleteMarker(${index})">删除</button>
        `;
        container.appendChild(div);
        autoResizeTextarea(div.querySelector('input'));
      });
    }

    function deleteMarker(index) {
      markers.splice(index, 1);
      renderMarkers();
    }

    document.getElementById('audioFile').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        if (wavesurfer) wavesurfer.destroy();
        wavesurfer = WaveSurfer.create({ container: '#waveform', waveColor: '#ddd', progressColor: '#007AFF' });
        wavesurfer.load(URL.createObjectURL(file));
      }
    });

    document.getElementById('playPause').addEventListener('click', () => {
      if (wavesurfer) wavesurfer.playPause();
    });

    document.getElementById('floatingAdd').addEventListener('click', () => {
      if (!wavesurfer) return;
      const time = wavesurfer.getCurrentTime() + parseFloat(document.getElementById('offset').value);
      markers.push({ time, text: '' });
      renderMarkers();
    });

    document.getElementById('export').addEventListener('click', () => {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(markers));
      const dl = document.createElement('a');
      dl.setAttribute("href", dataStr);
      dl.setAttribute("download", "打点记录.json");
      dl.click();
    });

    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('importFile').click();
    });

    document.getElementById('importFile').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        markers = JSON.parse(reader.result);
        renderMarkers();
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
