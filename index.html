<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸€é”®æ‰“ç‚¹å¬åŠ›å·¥å…·ï¼ˆæ‰‹æœºç‰ˆï¼‰</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    button {
      font-size: 1rem;
      padding: 8px 15px;
      margin: 5px;
      border-radius: 8px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    input[type=number], input[type=file], input[type=text] {
      padding: 5px;
      margin: 5px;
      font-size: 1rem;
    }
    #offsetInput {
      width: 60px;
    }
    .mark-entry {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin: 5px 0;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }
    .mark-header {
      display: flex;
      width: 100%;
      justify-content: space-between;
      align-items: center;
    }
    .mark-header span {
      color: #007BFF;
      cursor: pointer;
    }
    .mark-header span:hover {
      text-decoration: underline;
    }
    .note-input {
      width: 100%;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h2>ğŸ§ ä¸€é”®æ‰“ç‚¹å¬åŠ›å·¥å…·ï¼ˆæ‰‹æœºç‰ˆï¼‰</h2>

  <input type="file" id="fileInput" accept="audio/*"><br><br>
  <audio id="audioPlayer" controls style="width: 100%;"></audio><br>

  <button id="markButton">ğŸ”– æ‰“ç‚¹</button>
  <label>åç§»ç§’æ•°: <input type="number" id="offsetInput" value="3" min="0" max="5" step="0.1"></label><br>

  <button id="rewindButton">âª å›æ”¾ 5 ç§’</button>
  <button id="forwardButton">â© å¿«è¿› 5 ç§’</button><br>
  <button id="exportButton">ğŸ’¾ å¯¼å‡ºæ‰“ç‚¹</button>
  <input type="file" id="importInput" accept="application/json" style="display:none">
  <button id="importButton">ğŸ“‚ å¯¼å…¥æ‰“ç‚¹</button>

  <h3>æ ‡è®°ç‚¹ï¼š</h3>
  <ul id="marksList"></ul>

  <script>
    const fileInput = document.getElementById('fileInput');
    const audioPlayer = document.getElementById('audioPlayer');
    const markButton = document.getElementById('markButton');
    const offsetInput = document.getElementById('offsetInput');
    const marksList = document.getElementById('marksList');
    const rewindButton = document.getElementById('rewindButton');
    const forwardButton = document.getElementById('forwardButton');
    const exportButton = document.getElementById('exportButton');
    const importButton = document.getElementById('importButton');
    const importInput = document.getElementById('importInput');

    let marks = [];
    const STEP = 5;
    let currentAudioFileName = 'audio';

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        currentAudioFileName = file.name.replace(/\.[^/.]+$/, '');
        const url = URL.createObjectURL(file);
        audioPlayer.src = url;
        audioPlayer.load(); // ç¡®ä¿éŸ³é¢‘é‡æ–°åŠ è½½
        marks = [];
        marksList.innerHTML = '';
      }
    });

    markButton.addEventListener('click', () => {
      const offset = parseFloat(offsetInput.value) || 0;
      const currentTime = Math.max(0, audioPlayer.currentTime - offset);
      marks.push({time: currentTime, note: ''});
      renderMarks();
    });

    rewindButton.addEventListener('click', () => audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - STEP));
    forwardButton.addEventListener('click', () => audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + STEP));

    exportButton.addEventListener('click', () => {
      const dataStr = JSON.stringify(marks, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentAudioFileName}_æ‰“ç‚¹.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    importButton.addEventListener('click', () => importInput.click());
    importInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const importedMarks = JSON.parse(reader.result);
          if (Array.isArray(importedMarks)) {
            marks = importedMarks.map(m => ({time: Number(m.time), note: m.note || ''}));
            renderMarks();
          } else {
            alert('å¯¼å…¥æ–‡ä»¶æ ¼å¼é”™è¯¯');
          }
        } catch {
          alert('å¯¼å…¥æ–‡ä»¶æ ¼å¼é”™è¯¯');
        }
      };
      reader.readAsText(file);
    });

    function renderMarks() {
      marksList.innerHTML = '';
      marks.forEach((mark, index) => {
        const li = document.createElement('li');
        li.className = 'mark-entry';

        const headerDiv = document.createElement('div');
        headerDiv.className = 'mark-header';

        const timeSpan = document.createElement('span');
        timeSpan.textContent = `æ ‡è®° ${index + 1} - ${formatTime(mark.time)}`;
        timeSpan.addEventListener('click', () => { audioPlayer.currentTime = mark.time; audioPlayer.play(); });

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'åˆ é™¤';
        deleteBtn.style.padding = '3px 8px';
        deleteBtn.style.fontSize = '0.9rem';
        deleteBtn.addEventListener('click', () => {
          marks.splice(index, 1);
          renderMarks();
        });

        headerDiv.appendChild(timeSpan);
        headerDiv.appendChild(deleteBtn);

        const noteInput = document.createElement('input');
        noteInput.type = 'text';
        noteInput.placeholder = 'è®°å½•ä½ çš„ç–‘æƒ‘...';
        noteInput.className = 'note-input';
        noteInput.value = mark.note;
        noteInput.addEventListener('input', (e) => { mark.note = e.target.value; });

        li.appendChild(headerDiv);
        li.appendChild(noteInput);
        marksList.appendChild(li);
      });
    }

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = Math.floor(seconds % 60);
      return `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }
  </script>
</body>
</html>
