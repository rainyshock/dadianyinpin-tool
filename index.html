<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no,email=no,address=no">
  <title>å¬åŠ›éŸ³é¢‘æ‰“ç‚¹å·¥å…·</title>
  <style>
    html, body {
      -webkit-text-size-adjust: 100%;
      font-family: Arial, sans-serif;
    }
    body {
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
      padding: 0 10px 80px;
      background: #f7f7f7;
    }
    button {
      font-size: 16px;       
      min-height: 44px;      
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      touch-action: manipulation; 
    }
    button:hover { background-color: #45a049; }
    ul { list-style: none; padding: 0; margin: 0; }
    li {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 5px;
      background: #fff;
      border-radius: 6px;
      padding: 6px;
      margin: 6px 0;
      text-align: left;
    }
    li span {
      min-width: 60px;
      color: #007BFF;
      cursor: pointer;
      white-space: nowrap;
    }
    li span:hover { text-decoration: underline; }
    textarea.mark-note {
      flex: 1;
      padding: 2px;
      font-size: 16px;
      line-height: 20px;
      height: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: none;
      overflow: hidden;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .delete-btn {
      background: #FF3B30;
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 6px;
      white-space: nowrap;
      min-height: auto;
      height: auto;
    }
    .section { margin-bottom: 15px; }
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 600px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 10px;
      background: white;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
    }
    .bottom-bar button {
      flex: 1;
      margin: 0 5px;
    }
    .mark-btn-big {
      background: #ff9800;
      font-size: 20px;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h2>ğŸ§ å¬åŠ›éŸ³é¢‘æ‰“ç‚¹å·¥å…·</h2>

  <div class="section">
    <input type="file" id="fileInput" accept=".mp3,audio/*">
  </div>

  <div class="section">
    <audio id="audioPlayer" controls style="width: 100%;"></audio>
  </div>

  <div class="section">
    <button id="exportButton">ğŸ’¾ å¯¼å‡ºæ‰“ç‚¹</button>
    <input type="file" id="importInput" accept="application/json" style="display:none">
    <button id="importButton">ğŸ“‚ å¯¼å…¥æ‰“ç‚¹</button>
  </div>

  <h3>æ ‡è®°ç‚¹ï¼š</h3>
  <ul id="marksList"></ul>

  <div class="bottom-bar">
    <button id="rewindButton">âª -5s</button>
    <button id="markButton" class="mark-btn-big">ğŸ”– æ‰“ç‚¹</button>
    <button id="forwardButton">â© +5s</button>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const audioPlayer = document.getElementById('audioPlayer');
    const markButton = document.getElementById('markButton');
    const marksList = document.getElementById('marksList');
    const rewindButton = document.getElementById('rewindButton');
    const forwardButton = document.getElementById('forwardButton');
    const exportButton = document.getElementById('exportButton');
    const importButton = document.getElementById('importButton');
    const importInput = document.getElementById('importInput');
    const STEP = 5;

    let marks = [];
    let audioFileName = 'audio';
    let OFFSET = 2;

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      audioFileName = file.name.replace(/\.[^/.]+$/, "");
      audioPlayer.src = URL.createObjectURL(file);
      audioPlayer.load();
      marks = [];
      renderMarks();
    });

    function addMark() {
      if (!audioPlayer.src) return;
      const time = Math.max(0, audioPlayer.currentTime - OFFSET);
      marks.push({time, note: ''});
      renderMarks();
    }

    markButton.addEventListener('click', e => {
      e.preventDefault(); 
      addMark();
    });

    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key === ' ') { e.preventDefault(); audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause(); }
      if (e.key === 'Alt') addMark();
      if (e.key === 'ArrowLeft') audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - STEP);
      if (e.key === 'ArrowRight') audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + STEP);
    });

    rewindButton.addEventListener('click', () => audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - STEP));
    forwardButton.addEventListener('click', () => audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + STEP));

    exportButton.addEventListener('click', async () => {
      const dataStr = JSON.stringify(marks, null, 2);
      const fileName = audioFileName + '_æ‰“ç‚¹.json';
      const blob = new Blob([dataStr], { type: 'application/json' });

      // 1. ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿåˆ†äº«é¢æ¿
      if (navigator.canShare && navigator.canShare({ files: [new File([blob], fileName)] })) {
        try {
          await navigator.share({
            title: 'å¯¼å‡ºæ‰“ç‚¹',
            files: [new File([blob], fileName, { type: 'application/json' })]
          });
          return;
        } catch (err) {
          console.warn('ç”¨æˆ·å–æ¶ˆåˆ†äº«æˆ–ä¸æ”¯æŒ', err);
        }
      }

      // 2. å…¶æ¬¡å°è¯• showSaveFilePicker
      if (window.showSaveFilePicker) {
        try {
          const handle = await showSaveFilePicker({
            suggestedName: fileName,
            types: [{
              description: 'JSON æ–‡ä»¶',
              accept: {'application/json': ['.json']}
            }]
          });
          const writable = await handle.createWritable();
          await writable.write(blob);
          await writable.close();
          return;
        } catch (err) {
          console.warn('showSaveFilePicker å¤±è´¥ï¼Œå›é€€ä¸‹è½½', err);
        }
      }

      // 3. æœ€åå…œåº•ç”¨ a.download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    importButton.addEventListener('click', () => importInput.click());
    importInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          marks = Array.isArray(data) ? data : [];
          renderMarks();
        } catch { alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); }
      };
      reader.readAsText(file);
    });

    function renderMarks() {
      marksList.innerHTML = '';
      marks.forEach((m, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${formatTime(m.time)}</span>
          <textarea class="mark-note" placeholder="è®°å½•ä½ çš„ç–‘é—®">${m.note || ''}</textarea>
          <button class="delete-btn">åˆ é™¤</button>
        `;
        const noteBox = li.querySelector('.mark-note');

        const lineHeight = 20;
        function updateHeight() {
          const lines = noteBox.value.split('\n').length;
          noteBox.style.height = (Math.max(lines, 1) * lineHeight) + 'px';
        }

        noteBox.addEventListener('input', () => {
          m.note = noteBox.value;
          updateHeight();
        });

        updateHeight();

        li.querySelector('.delete-btn').addEventListener('click', () => { marks.splice(i, 1); renderMarks(); });
        li.querySelector('span').addEventListener('click', () => { audioPlayer.currentTime = m.time; audioPlayer.play(); });
        marksList.appendChild(li);
      });
    }

    function formatTime(s) {
      const min = Math.floor(s / 60), sec = Math.floor(s % 60);
      return `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }
  </script>
</body>
</html>
